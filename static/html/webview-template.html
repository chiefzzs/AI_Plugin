<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Interactive Tool</title>
  <link rel="stylesheet" href="{{styleCssPath}}">
</head>
<body>
  <div id="app">
    <!-- Vueåº”ç”¨å†…å®¹ -->
    <div class="container">
      <h1>Interactive Tool</h1>
      
      <!-- å·¥å…·é€‰æ‹©åŒºåŸŸ -->
      <div class="tool-selection">
        <label for="toolName">é€‰æ‹©å·¥å…·ï¼š</label>
        <select v-model="selectedTool" id="toolName">
          <option value="execinfo">æ‰§è¡Œä¿¡æ¯å·¥å…· (execinfo)</option>
          <option value="interactive_tool">äº¤äº’å¼å·¥å…· (interactive_tool)</option>
        </select>
      </div>
      
      <!-- è¾“å…¥åŒºåŸŸ -->
      <div class="input-area">
        <textarea v-model="inputCommand" placeholder="è¾“å…¥å‘½ä»¤..." rows="4"></textarea>
        <div class="button-group">
          <button @click="executeTool" :disabled="isExecuting || !inputCommand.trim()">æ‰§è¡Œ</button>
          <button @click="cancelExecution" :disabled="!isExecuting">å–æ¶ˆ</button>
          <button @click="clearOutput">æ¸…ç©º</button>
        </div>
      </div>
      
      <!-- çŠ¶æ€ä¿¡æ¯ -->
      <div class="status-bar">
        <span v-if="isExecuting" class="status-executing">æ‰§è¡Œä¸­...</span>
        <span v-else class="status-ready">å°±ç»ª</span>
        <span class="process-count">æ´»è·ƒè¿›ç¨‹: {{ activeProcessCount }}</span>
        <span v-if="lastExecutionTime" class="execution-time">ä¸Šæ¬¡æ‰§è¡Œ: {{ lastExecutionTime }}</span>
      </div>
      
      <!-- è¾“å‡ºåŒºåŸŸ -->
      <div class="output-area">
        <div class="output-header">è¾“å‡ºç»“æœï¼š</div>
        <div class="output-content" ref="outputContent">
          <div v-for="(message, index) in messages" :key="index" :class="['message-line', message.type]">
            <span v-if="message.type === 'error'" class="error-icon">âŒ</span>
            <span v-else-if="message.type === 'command'" class="command-icon">ğŸ”§</span>
            <span v-else-if="message.type === 'text'" class="text-icon">ğŸ“</span>
            <span v-else class="default-icon">â€¢</span>
            <span class="message-content">{{ message.content }}</span>
          </div>
        </div>
      </div>
      
      <!-- å†å²å‘½ä»¤ -->
      <div v-if="commandHistory.length > 0" class="history-section">
        <div class="history-header">å†å²å‘½ä»¤ï¼š</div>
        <div class="history-list">
          <button v-for="(cmd, index) in commandHistory" :key="index" @click="loadHistoryCommand(cmd)" class="history-item">
            {{ cmd }}
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- ç›´æ¥å¼•ç”¨Vue2å’Œç›¸å…³JSæ–‡ä»¶ -->
  <script src="{{vueJsPath}}"></script>
  <script src="{{vueI18nJsPath}}"></script>
  <script src="{{appJsPath}}"></script>
  
  <script>
    // Vueåº”ç”¨å®ä¾‹
    new Vue({
      el: '#app',
      data: {
        selectedTool: 'execinfo',
        inputCommand: '',
        messages: [],
        isExecuting: false,
        currentSequenceId: null,
        activeProcessCount: 0,
        commandHistory: [],
        historyLimit: 10,
        lastExecutionTime: null
      },
      mounted() {
        // æ³¨å†Œæ¶ˆæ¯æ¥æ”¶å¤„ç†
        window.addEventListener('message', this.handleExtensionMessage);
        
        // è¯·æ±‚è·å–æ´»è·ƒè¿›ç¨‹æ•°
        this.updateActiveProcessCount();
      },
      methods: {
        // æ‰§è¡Œå·¥å…·
        executeTool() {
          if (!this.inputCommand.trim() || this.isExecuting) {
            return;
          }
          
          // ç”Ÿæˆå”¯ä¸€åºåˆ—ID
          this.currentSequenceId = 'seq-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
          
          // è®°å½•å†å²å‘½ä»¤
          this.addToHistory(this.inputCommand.trim());
          
          // æ›´æ–°çŠ¶æ€
          this.isExecuting = true;
          this.lastExecutionTime = new Date().toLocaleString();
          
          // æ¸…ç©ºä¹‹å‰çš„æ¶ˆæ¯
          this.messages = [];
          
          // æ·»åŠ æ‰§è¡Œä¿¡æ¯
          this.addMessage('command', `[æ‰§è¡Œå‘½ä»¤] ${this.inputCommand.trim()} (å·¥å…·: ${this.selectedTool})`);
          
          // å‘é€æ‰§è¡Œè¯·æ±‚åˆ°æ‰©å±•
          this.sendMessage({
            command: 'executeTool',
            toolName: this.selectedTool,
            text: this.inputCommand.trim(),
            sequenceId: this.currentSequenceId
          });
        },
        
        // å–æ¶ˆæ‰§è¡Œ
        cancelExecution() {
          if (this.isExecuting && this.currentSequenceId) {
            this.sendMessage({
              command: 'cancelExecution',
              sequenceId: this.currentSequenceId
            });
          }
        },
        
        // æ¸…ç©ºè¾“å‡º
        clearOutput() {
          this.messages = [];
        },
        
        // åŠ è½½å†å²å‘½ä»¤
        loadHistoryCommand(command) {
          this.inputCommand = command;
        },
        
        // æ·»åŠ æ¶ˆæ¯åˆ°è¾“å‡º
        addMessage(type, content) {
          this.messages.push({ type, content });
          // æ»šåŠ¨åˆ°åº•éƒ¨
          this.$nextTick(() => {
            const outputContent = this.$refs.outputContent;
            if (outputContent) {
              outputContent.scrollTop = outputContent.scrollHeight;
            }
          });
        },
        
        // æ·»åŠ åˆ°å†å²è®°å½•
        addToHistory(command) {
          // é¿å…é‡å¤æ·»åŠ 
          if (!this.commandHistory.includes(command)) {
            this.commandHistory.unshift(command);
            // é™åˆ¶å†å²è®°å½•æ•°é‡
            if (this.commandHistory.length > this.historyLimit) {
              this.commandHistory.pop();
            }
          }
        },
        
        // å‘é€æ¶ˆæ¯åˆ°æ‰©å±•
        sendMessage(message) {
          if (window.parent !== window) {
            window.parent.postMessage(message, '*');
          }
        },
        
        // å¤„ç†æ¥è‡ªæ‰©å±•çš„æ¶ˆæ¯
        handleExtensionMessage(event) {
          const message = event.data;
          
          switch (message.command) {
            case 'toolResponse':
              // å¤„ç†å·¥å…·å“åº”
              if (message.response) {
                const response = message.response;
                this.addMessage(response.type, response.content);
                
                // æ£€æŸ¥æ˜¯å¦æ‰§è¡Œç»“æŸ
                if (response.isEnd) {
                  this.isExecuting = false;
                  this.addMessage('info', `[æ‰§è¡Œç»“æŸ] å‘½ä»¤æ‰§è¡Œå®Œæˆ`);
                  this.updateActiveProcessCount();
                }
              }
              break;
              
            case 'toolError':
              // å¤„ç†å·¥å…·é”™è¯¯
              this.addMessage('error', `[æ‰§è¡Œé”™è¯¯] ${message.error}`);
              this.isExecuting = false;
              this.updateActiveProcessCount();
              break;
              
            case 'executionCancelled':
              // å¤„ç†æ‰§è¡Œå–æ¶ˆ
              this.addMessage('info', `[æ‰§è¡Œå–æ¶ˆ] å‘½ä»¤æ‰§è¡Œå·²å–æ¶ˆ`);
              this.isExecuting = false;
              this.updateActiveProcessCount();
              break;
              
            case 'activeProcessesCount':
              // æ›´æ–°æ´»è·ƒè¿›ç¨‹æ•°
              this.activeProcessCount = message.count;
              break;
          }
        },
        
        // æ›´æ–°æ´»è·ƒè¿›ç¨‹æ•°
        updateActiveProcessCount() {
          this.sendMessage({
            command: 'getActiveProcesses'
          });
        }
      }
    });
  </script>
</body>
</html>