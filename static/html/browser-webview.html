<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Interactive Tool (æµè§ˆå™¨ç‰ˆ)</title>
  <link rel="stylesheet" href="../css/style.css">
  <!-- ç›´æ¥å¼•ç”¨Vue2çš„CDN -->
  <script src="../js/vue.min.js"></script>
</head>
<body>
  <div id="app">
    <!-- Vueåº”ç”¨å†…å®¹ -->
    <div class="container">
      <h1>Interactive Tool (æµè§ˆå™¨ç‰ˆ)</h1>
      
      <!-- APIæœåŠ¡å™¨é…ç½® -->
      <div class="api-config">
        <label for="commMode">é€šä¿¡æ¨¡å¼ï¼š</label>
        <select v-model="commMode" id="commMode" @change="onCommModeChange">
          <option value="plugin">é€šè¿‡æ’ä»¶é€šä¿¡</option>
          <option value="direct">ç›´æ¥ä¸Pythoné€šä¿¡</option>
        </select>
      </div>
      
      <div class="api-config">
        <label for="apiUrl">APIæœåŠ¡å™¨åœ°å€ï¼š</label>
        <input v-model="apiUrl" id="apiUrl" type="text" placeholder="http://localhost:5000/api">
        <button @click="testApiConnection" :disabled="isTestingConnection">æµ‹è¯•è¿æ¥</button>
        <span v-if="connectionStatus" :class="connectionStatus === 'connected' ? 'status-connected' : 'status-error'">
          {{ connectionStatus === 'connected' ? 'å·²è¿æ¥' : 'è¿æ¥å¤±è´¥' }}
        </span>
      </div>
      
      <!-- å·¥å…·é€‰æ‹©åŒºåŸŸ -->
      <div class="tool-selection">
        <label for="toolName">é€‰æ‹©å·¥å…·ï¼š</label>
        <select v-model="selectedTool" id="toolName">
          <option value="execinfo">æ‰§è¡Œä¿¡æ¯å·¥å…· (execinfo)</option>
          <option value="interactive_tool">äº¤äº’å¼å·¥å…· (interactive_tool)</option>
        </select>
      </div>
      
      <!-- è¾“å…¥åŒºåŸŸ -->
      <div class="input-area">
        <textarea v-model="inputCommand" placeholder="è¾“å…¥å‘½ä»¤..." rows="4"></textarea>
        <div class="button-group">
          <button @click="executeTool" :disabled="isExecuting || !inputCommand.trim() || !isConnected">æ‰§è¡Œ</button>
          <button @click="cancelExecution" :disabled="!isExecuting">å–æ¶ˆ</button>
          <button @click="clearOutput">æ¸…ç©º</button>
        </div>
      </div>
      
      <!-- çŠ¶æ€ä¿¡æ¯ -->
      <div class="status-bar">
        <span v-if="isExecuting" class="status-executing">æ‰§è¡Œä¸­...</span>
        <span v-else class="status-ready">å°±ç»ª</span>
        <span v-if="lastExecutionTime" class="execution-time">ä¸Šæ¬¡æ‰§è¡Œ: {{ lastExecutionTime }}</span>
      </div>
      
      <!-- è¾“å‡ºåŒºåŸŸ -->
      <div class="output-area">
        <div class="output-header">è¾“å‡ºç»“æœï¼š</div>
        <div class="output-content" ref="outputContent">
          <div v-for="(message, index) in messages" :key="index" :class="['message-line', message.type]">
            <span v-if="message.type === 'error'" class="error-icon">âŒ</span>
            <span v-else-if="message.type === 'command'" class="command-icon">ğŸ”§</span>
            <span v-else-if="message.type === 'text'" class="text-icon">ğŸ“</span>
            <span v-else class="default-icon">â€¢</span>
            <span class="message-content">{{ message.content }}</span>
          </div>
        </div>
      </div>
      
      <!-- å¤„ç†é‡‘é¢æ•°æ®æŒ‰é’® - è¾“å…¥3æ—¶æ˜¾ç¤º -->
      <div class="special-action" v-if="showAmountButton">
        <button @click="handleAmountData" :disabled="isExecuting || !isConnected" class="special-action-btn">
          å¤„ç†é‡‘é¢æ•°æ®
        </button>
      </div>
      
      <!-- å†å²å‘½ä»¤ -->
      <div v-if="commandHistory.length > 0" class="history-section">
        <div class="history-header">å†å²å‘½ä»¤ï¼š</div>
        <div class="history-list">
          <button v-for="(cmd, index) in commandHistory" :key="index" @click="loadHistoryCommand(cmd)" class="history-item">
            {{ cmd }}
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // JSONå¤„ç†æœåŠ¡ - å°†mockä»£ç å’ŒVSCodeæ’ä»¶ä»£ç åˆ†ç¦»
    class JsonProcessService {
      constructor(appInstance) {
        this.app = appInstance;
      }
      
      // å¤„ç†å·¥å…·å“åº”ï¼ˆé€šç”¨é€»è¾‘ï¼‰
      processToolResponse(response) {
        // æ·»åŠ è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—
        console.log('æ”¶åˆ°å·¥å…·å“åº”:', {responseType: response?.type, response: response});
        
        if (response.type === 'error') {
          this.app.addMessage('error', response.content);
        } else {
          this.app.addMessage(response.type || 'text', response.content);
          
          // è®°å½•å½“å‰showAmountButtonçŠ¶æ€
          console.log('å½“å‰showAmountButtonçŠ¶æ€:', this.app.showAmountButton);
          
          // æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºé‡‘é¢å¤„ç†æŒ‰é’®
          // æ¡ä»¶ï¼š
          // 1. å½“æ¥æ”¶åˆ°çš„JSONå“åº”ä¸­typeå­—æ®µä¸º'command'
          // 2. æˆ–è€…å½“è¾“å…¥å‘½ä»¤ä¸º'3'ï¼ˆå‘åå…¼å®¹ï¼‰
          console.log('æ£€æŸ¥æŒ‰é’®æ˜¾ç¤ºæ¡ä»¶:', {
            responseType: response.type,
            isCommandType: response.type === 'command',
            lastInputCommand: this.app.lastInputCommand,
            isInputCommand3: this.app.lastInputCommand === '3'
          });
          
          if (response.type === 'command' || this.app.lastInputCommand === '3') {
            console.log('è§¦å‘æ˜¾ç¤ºé‡‘é¢å¤„ç†æŒ‰é’®:', {responseType: response.type, lastInputCommand: this.app.lastInputCommand});
            this.app.showAmountButton = true;
          } else {
            console.log('ä¸æ˜¾ç¤ºé‡‘é¢å¤„ç†æŒ‰é’®:', {responseType: response.type, lastInputCommand: this.app.lastInputCommand});
            this.app.showAmountButton = false;
          }
          
          // è®°å½•æ›´æ–°åçš„showAmountButtonçŠ¶æ€
          console.log('æ›´æ–°åshowAmountButtonçŠ¶æ€:', this.app.showAmountButton);
          // æ‰‹åŠ¨è§¦å‘Vueå“åº”å¼æ›´æ–°
          this.app.$forceUpdate();
        }
      }
      
      // Mockæ¨¡å¼ - ç›´æ¥ä¸RESTful APIäº¤äº’
      executeDirectMode(requestUrl, requestData) {
        // åˆ›å»ºAbortControllerç”¨äºå–æ¶ˆè¯·æ±‚
        const controller = new AbortController();
        const { signal } = controller;
        
        // å­˜å‚¨è¯·æ±‚æ§åˆ¶å™¨ï¼Œç”¨äºå–æ¶ˆåŠŸèƒ½
        this.app.activeRequests.set(this.app.currentSequenceId, controller);
        
        // å‘é€æ‰§è¡Œè¯·æ±‚åˆ°ç›´æ¥é€šä¿¡æœåŠ¡å™¨
        fetch(requestUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestData),
          signal: signal,
          mode: 'cors' // å¯ç”¨è·¨åŸŸè¯·æ±‚
        })
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTPé”™è¯¯: ${response.status}`);
            }
            return response.json();
          })
          .then(data => {
            // å¤„ç†APIå“åº”
            if (data.success) {
              this.processToolResponse(data.result);
            } else {
              throw new Error(data.error || 'å·¥å…·æ‰§è¡Œå¤±è´¥');
            }
          })
          .catch(error => {
            // ä¸å¤„ç†AbortErrorï¼Œå› ä¸ºè¿™æ˜¯ç”¨æˆ·ä¸»åŠ¨å–æ¶ˆçš„
            if (error.name !== 'AbortError') {
              this.app.addMessage('error', `[æ‰§è¡Œé”™è¯¯] ${error.message}`);
            }
          })
          .finally(() => {
            this.app.isExecuting = false;
            this.app.activeRequests.delete(this.app.currentSequenceId);
            this.app.addMessage('info', `[æ‰§è¡Œç»“æŸ] å‘½ä»¤æ‰§è¡Œå®Œæˆ`);
          });
      }
      
      // Mockæ¨¡å¼ - å¤„ç†é‡‘é¢æ•°æ®
      processAmountDataDirect(amountData) {
        // ç”Ÿæˆå”¯ä¸€åºåˆ—ID
        this.app.currentSequenceId = 'seq-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        
        // æ›´æ–°çŠ¶æ€
        this.app.isExecuting = true;
        this.app.lastExecutionTime = new Date().toLocaleString();
        
        // æ¸…ç©ºä¹‹å‰çš„æ¶ˆæ¯
        this.app.messages = [];
        
        // æ·»åŠ æ‰§è¡Œä¿¡æ¯
        this.app.addMessage('command', `[æ‰§è¡Œå‘½ä»¤] ç›´æ¥è°ƒç”¨Pythonå¤„ç†é‡‘é¢æ•°æ®`);
        
        // æ„é€ è¯·æ±‚ä½“
        const requestData = {
          amountData: amountData,
          sequenceId: this.app.currentSequenceId
        };
        
        // æ„é€ è¯·æ±‚URL
        const requestUrl = `${this.app.currentApiUrl}/process-amount`;
        
        // å‘é€æ‰§è¡Œè¯·æ±‚åˆ°ç›´æ¥é€šä¿¡æœåŠ¡å™¨
        this.executeDirectMode(requestUrl, requestData);
      }
    }
    
    // Vueåº”ç”¨å®ä¾‹
    new Vue({
      el: '#app',
      data: {
        commMode: 'plugin', // é€šä¿¡æ¨¡å¼ï¼šplugin(é€šè¿‡æ’ä»¶) æˆ– direct(ç›´æ¥é€šä¿¡)
        apiUrl: 'http://localhost:5000/api',
        directCommUrl: 'http://localhost:5001', // ç›´æ¥é€šä¿¡æœåŠ¡å™¨åœ°å€
        selectedTool: 'execinfo',
        inputCommand: '',
        messages: [],
        isExecuting: false,
        currentSequenceId: null,
        commandHistory: [],
        historyLimit: 10,
        lastExecutionTime: null,
        connectionStatus: null,
        isTestingConnection: false,
        isConnected: false,
        activeRequests: new Map(), // å­˜å‚¨æ´»è·ƒçš„è¯·æ±‚ï¼Œç”¨äºå–æ¶ˆåŠŸèƒ½
        showAmountButton: false, // æ§åˆ¶æ˜¯å¦æ˜¾ç¤ºé‡‘é¢å¤„ç†æŒ‰é’®
        lastInputCommand: '', // å­˜å‚¨ä¸Šæ¬¡è¾“å…¥çš„å‘½ä»¤
        jsonProcessService: null // JSONå¤„ç†æœåŠ¡å®ä¾‹
      },
      mounted() {
        // åˆå§‹åŒ–JSONå¤„ç†æœåŠ¡
        this.jsonProcessService = new JsonProcessService(this);
        // è®¾ç½®é»˜è®¤APIåœ°å€
        this.testApiConnection();
      },
      
      computed: {
        // è·å–å½“å‰ä½¿ç”¨çš„APIåœ°å€
        currentApiUrl() {
          return this.commMode === 'direct' ? this.directCommUrl : this.apiUrl;
        }
      },
      methods: {
        // é€šä¿¡æ¨¡å¼æ”¹å˜æ—¶çš„å¤„ç†
        onCommModeChange() {
          this.isConnected = false;
          this.connectionStatus = null;
          this.messages = [];
          this.addMessage('info', `é€šä¿¡æ¨¡å¼å·²åˆ‡æ¢ä¸º: ${this.commMode === 'direct' ? 'ç›´æ¥ä¸Pythoné€šä¿¡' : 'é€šè¿‡æ’ä»¶é€šä¿¡'}`);
          this.testApiConnection();
        },
        
        // æµ‹è¯•APIè¿æ¥
        testApiConnection() {
        this.isTestingConnection = true;
        this.connectionStatus = null;
        
        // æ„é€ æµ‹è¯•è¿æ¥çš„URL
        const testUrl = `${this.currentApiUrl}/test`;
        
        this.addMessage('info', `æ­£åœ¨æµ‹è¯•${this.commMode === 'direct' ? 'ç›´æ¥é€šä¿¡' : 'API'}è¿æ¥: ${testUrl}`);
        
        fetch(testUrl)
          .then(response => {
            if (response.ok) {
              this.connectionStatus = 'connected';
              this.isConnected = true;
              this.addMessage('info', `${this.commMode === 'direct' ? 'ç›´æ¥é€šä¿¡' : 'API'}è¿æ¥æˆåŠŸ: ${testUrl}`);
            } else {
              throw new Error(`HTTPé”™è¯¯: ${response.status}`);
            }
          })
            .catch(error => {
              this.connectionStatus = 'error';
              this.isConnected = false;
              this.addMessage('error', `APIè¿æ¥å¤±è´¥: ${error.message}`);
            })
            .finally(() => {
              this.isTestingConnection = false;
            });
        },
        
        // æ‰§è¡Œå·¥å…·
        executeTool() {
        if (!this.inputCommand.trim() || this.isExecuting || !this.isConnected) {
          return;
        }
        
        // ä¿å­˜å½“å‰è¾“å…¥å‘½ä»¤
        this.lastInputCommand = this.inputCommand.trim();
        
        // ç”Ÿæˆå”¯ä¸€åºåˆ—ID
        this.currentSequenceId = 'seq-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        
        // è®°å½•å†å²å‘½ä»¤
        this.addToHistory(this.lastInputCommand);
        
        // æ›´æ–°çŠ¶æ€
        this.isExecuting = true;
        this.lastExecutionTime = new Date().toLocaleString();
        
        // æ¸…ç©ºä¹‹å‰çš„æ¶ˆæ¯
        this.messages = [];
        
        // æ·»åŠ æ‰§è¡Œä¿¡æ¯
        this.addMessage('command', `[æ‰§è¡Œå‘½ä»¤] ${this.lastInputCommand} (å·¥å…·: ${this.selectedTool})`);
        
        // æ„é€ è¯·æ±‚ä½“
        const requestData = {
          toolName: this.selectedTool,
          command: this.inputCommand.trim(),
          sequenceId: this.currentSequenceId
        };
        
        // æ ¹æ®é€šä¿¡æ¨¡å¼é€‰æ‹©ä¸åŒçš„APIè°ƒç”¨æ–¹å¼
        if (this.commMode === 'direct') {
          // ç›´æ¥é€šä¿¡æ¨¡å¼
          const requestUrl = `${this.currentApiUrl}/execute`;
          this.executeToolDirect(requestUrl, requestData);
        } else {
          // é€šè¿‡æ’ä»¶é€šä¿¡æ¨¡å¼
          const requestUrl = `${this.currentApiUrl}/execute/stream`;
          
          // å‘é€æ‰§è¡Œè¯·æ±‚åˆ°APIï¼ˆä½¿ç”¨Server-Sent Eventsï¼‰
          try {
            // åˆ›å»ºEventSource
            this.eventSource = new EventSource(requestUrl, { withCredentials: true });
            
            // å­˜å‚¨å½“å‰çš„EventSource
            this.activeRequests.set(this.currentSequenceId, this.eventSource);
            
            // ç›‘å¬messageäº‹ä»¶
            this.eventSource.addEventListener('message', (event) => {
              try {
                // è§£ææ•°æ®
                const data = JSON.parse(event.data);
                
                // å¤„ç†å·¥å…·å“åº”
                if (data.type === 'complete') {
                  // æ‰§è¡Œå®Œæˆ
                  this.isExecuting = false;
                  if (data.error) {
                    this.addMessage('error', `[æ‰§è¡Œå¤±è´¥] ${data.error}`);
                  } else {
                    this.addMessage('info', `[æ‰§è¡Œç»“æŸ] å‘½ä»¤æ‰§è¡Œå®Œæˆ`);
                  }
                  // å…³é—­EventSource
                  this.cleanupEventSource();
                } else {
                  this.processToolResponse(data);
                }
              } catch (error) {
                this.addMessage('error', `[æ•°æ®è§£æé”™è¯¯] ${error.message}`);
              }
            });
            
            // ç›‘å¬é”™è¯¯äº‹ä»¶
            this.eventSource.addEventListener('error', (error) => {
              this.addMessage('error', `[è¿æ¥é”™è¯¯] ${error.type}`);
              this.isExecuting = false;
              this.cleanupEventSource();
            });
          } catch (error) {
            // å¦‚æœæµè§ˆå™¨ä¸æ”¯æŒEventSourceï¼Œä½¿ç”¨æ™®é€šè¯·æ±‚ä½œä¸ºå¤‡é€‰
            this.executeToolFallback(requestUrl, requestData);
          }
        }
        },
        
        // ç›´æ¥é€šä¿¡æ¨¡å¼çš„æ‰§è¡Œæ–¹æ³•
        executeToolDirect(requestUrl, requestData) {
          // ä½¿ç”¨JSONå¤„ç†æœåŠ¡æ‰§è¡Œç›´æ¥é€šä¿¡æ¨¡å¼çš„è¯·æ±‚
          this.jsonProcessService.executeDirectMode(requestUrl, requestData);
        },
        
        // å¤‡é€‰æ‰§è¡Œæ–¹æ³•ï¼ˆå½“EventSourceä¸å¯ç”¨æ—¶ï¼‰
        executeToolFallback(requestUrl, requestData) {
        // åˆ›å»ºAbortControllerç”¨äºå–æ¶ˆè¯·æ±‚
        const controller = new AbortController();
        const { signal } = controller;
        
        // å­˜å‚¨è¯·æ±‚æ§åˆ¶å™¨ï¼Œç”¨äºå–æ¶ˆåŠŸèƒ½
        this.activeRequests.set(this.currentSequenceId, controller);
        
        // å‘é€æ‰§è¡Œè¯·æ±‚åˆ°API
        fetch(requestUrl.replace('/stream', ''), {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestData),
          signal: signal
        })
            .then(response => {
              if (!response.ok) {
                throw new Error(`HTTPé”™è¯¯: ${response.status}`);
              }
              return response.json();
            })
            .then(data => {
              // å¤„ç†APIå“åº”
              if (data.success) {
                this.processToolResponse(data.result);
              } else {
                throw new Error(data.error || 'å·¥å…·æ‰§è¡Œå¤±è´¥');
              }
            })
            .catch(error => {
              // ä¸å¤„ç†AbortErrorï¼Œå› ä¸ºè¿™æ˜¯ç”¨æˆ·ä¸»åŠ¨å–æ¶ˆçš„
              if (error.name !== 'AbortError') {
                this.addMessage('error', `[æ‰§è¡Œé”™è¯¯] ${error.message}`);
              }
            })
            .finally(() => {
              this.isExecuting = false;
              this.activeRequests.delete(this.currentSequenceId);
              this.addMessage('info', `[æ‰§è¡Œç»“æŸ] å‘½ä»¤æ‰§è¡Œå®Œæˆ`);
            });
        },
        
        // æ¸…ç†EventSource
        cleanupEventSource() {
          if (this.eventSource) {
            this.eventSource.close();
            this.eventSource = null;
          }
          if (this.currentSequenceId) {
            this.activeRequests.delete(this.currentSequenceId);
          }
        },
        
        // å–æ¶ˆæ‰§è¡Œ
        cancelExecution() {
          if (this.isExecuting && this.currentSequenceId) {
            // å°è¯•é€šè¿‡APIå–æ¶ˆ
            const cancelUrl = `${this.apiUrl}/cancel`;
            fetch(cancelUrl, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ sequenceId: this.currentSequenceId })
            }).then(() => {
              this.addMessage('info', `[æ‰§è¡Œå–æ¶ˆ] å‘½ä»¤æ‰§è¡Œå·²å–æ¶ˆ`);
            }).catch(() => {
              // å¿½ç•¥å–æ¶ˆè¯·æ±‚çš„é”™è¯¯
            });
            
            // æ¸…ç†æœ¬åœ°èµ„æº
            this.cleanupEventSource();
            this.isExecuting = false;
          }
        },
        
        // å¤„ç†å·¥å…·å“åº”
        processToolResponse(response) {
          // ä½¿ç”¨JSONå¤„ç†æœåŠ¡å¤„ç†å·¥å…·å“åº”
          this.jsonProcessService.processToolResponse(response);
        },
        
        // æ¸…ç©ºè¾“å‡º
        clearOutput() {
          this.messages = [];
        },
        
        // åŠ è½½å†å²å‘½ä»¤
        loadHistoryCommand(command) {
          this.inputCommand = command;
        },
        
        // æ·»åŠ æ¶ˆæ¯åˆ°è¾“å‡º
        addMessage(type, content) {
          this.messages.push({ type, content });
          // æ»šåŠ¨åˆ°åº•éƒ¨
          this.$nextTick(() => {
            const outputContent = this.$refs.outputContent;
            if (outputContent) {
              outputContent.scrollTop = outputContent.scrollHeight;
            }
          });
        },
        
        // æ·»åŠ åˆ°å†å²è®°å½•
        addToHistory(command) {
          // é¿å…é‡å¤æ·»åŠ 
          if (!this.commandHistory.includes(command)) {
            this.commandHistory.unshift(command);
            // é™åˆ¶å†å²è®°å½•æ•°é‡
            if (this.commandHistory.length > this.historyLimit) {
              this.commandHistory.pop();
            }
          }
        },
        
        // å¤„ç†é‡‘é¢æ•°æ®
        handleAmountData() {
        if (this.isExecuting || !this.isConnected) {
          return;
        }
        
        // æ„é€ é‡‘é¢æ•°æ®ï¼ˆmockæ•°æ®ï¼‰
        const amountData = {
          id: 'tx-' + Date.now(),
          amount: 1000.00,
          currency: 'CNY',
          description: 'æµ‹è¯•é‡‘é¢æ•°æ®',
          timestamp: new Date().toISOString()
        };
        
        this.addMessage('info', `[é‡‘é¢æ•°æ®å¤„ç†] æ„é€ é‡‘é¢æ•°æ®: ${JSON.stringify(amountData)}`);
        
        // æ ¹æ®é€šä¿¡æ¨¡å¼é€‰æ‹©ä¸åŒçš„å¤„ç†æ–¹å¼
        if (this.commMode === 'direct') {
          // ç›´æ¥é€šä¿¡æ¨¡å¼ - ç›´æ¥è°ƒç”¨å¤„ç†é‡‘é¢æ•°æ®çš„API
          this.callProcessAmountDirect(amountData);
        } else {
          // é€šè¿‡æ’ä»¶é€šä¿¡æ¨¡å¼ - è°ƒç”¨execinfoå·¥å…·æ¥æ‰§è¡Œcmd-third.py
          this.callExecInfo(amountData);
        }
        },
        
        // è°ƒç”¨execinfoå·¥å…·
        callExecInfo(amountData) {
          // ç”Ÿæˆå”¯ä¸€åºåˆ—ID
          this.currentSequenceId = 'seq-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
          
          // æ›´æ–°çŠ¶æ€
          this.isExecuting = true;
          this.lastExecutionTime = new Date().toLocaleString();
          
          // æ¸…ç©ºä¹‹å‰çš„æ¶ˆæ¯
          this.messages = [];
          
          // æ·»åŠ æ‰§è¡Œä¿¡æ¯
          this.addMessage('command', `[æ‰§è¡Œå‘½ä»¤] è°ƒç”¨cmd-third.pyå¤„ç†é‡‘é¢æ•°æ® (å·¥å…·: execinfo)`);
          
          // æ„é€ è¯·æ±‚ä½“ - é€šè¿‡execinfoè°ƒç”¨cmd-third.py
          const requestData = {
            toolName: 'execinfo',
            command: `python d:\\learnning\\plugin\\tools\\cmd-third.py "${JSON.stringify(amountData).replace(/"/g, '\\"')}"`,
            sequenceId: this.currentSequenceId
          };
          
          // æ„é€ è¯·æ±‚URL
          const requestUrl = `${this.apiUrl}/execute/stream`;
          
          // å‘é€æ‰§è¡Œè¯·æ±‚åˆ°API
          this.executeToolFallbackForExecInfo(requestUrl, requestData);
        },
        
        // ç›´æ¥é€šä¿¡æ¨¡å¼ä¸‹å¤„ç†é‡‘é¢æ•°æ®
        callProcessAmountDirect(amountData) {
          // ä½¿ç”¨JSONå¤„ç†æœåŠ¡å¤„ç†é‡‘é¢æ•°æ®
          this.jsonProcessService.processAmountDataDirect(amountData);
        },
        
        // ä¸ºexecinfoå·¥å…·çš„å¤‡é€‰æ‰§è¡Œæ–¹æ³•
        executeToolFallbackForExecInfo(requestUrl, requestData) {
        // åˆ›å»ºAbortControllerç”¨äºå–æ¶ˆè¯·æ±‚
        const controller = new AbortController();
        const { signal } = controller;
        
        // å­˜å‚¨è¯·æ±‚æ§åˆ¶å™¨ï¼Œç”¨äºå–æ¶ˆåŠŸèƒ½
        this.activeRequests.set(this.currentSequenceId, controller);
        
        // å‘é€æ‰§è¡Œè¯·æ±‚åˆ°API
        fetch(requestUrl.replace('/stream', ''), {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestData),
          signal: signal
        })
            .then(response => {
              if (!response.ok) {
                throw new Error(`HTTPé”™è¯¯: ${response.status}`);
              }
              return response.json();
            })
            .then(data => {
              // å¤„ç†APIå“åº”
              if (data.success) {
                this.processToolResponse(data.result);
              } else {
                throw new Error(data.error || 'å·¥å…·æ‰§è¡Œå¤±è´¥');
              }
            })
            .catch(error => {
              // ä¸å¤„ç†AbortErrorï¼Œå› ä¸ºè¿™æ˜¯ç”¨æˆ·ä¸»åŠ¨å–æ¶ˆçš„
              if (error.name !== 'AbortError') {
                this.addMessage('error', `[æ‰§è¡Œé”™è¯¯] ${error.message}`);
              }
            })
            .finally(() => {
              this.isExecuting = false;
              this.activeRequests.delete(this.currentSequenceId);
              this.addMessage('info', `[æ‰§è¡Œç»“æŸ] é‡‘é¢æ•°æ®å¤„ç†å®Œæˆ`);
            });
        }
      }
    });
  </script>
</body>
</html>